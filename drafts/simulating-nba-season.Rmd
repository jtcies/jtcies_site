```{r setup}
library(tidyverse)
library(rethinking)
library(jtcr)
library(lubridate)
library(ggrepel)
library(scales)
library(readxl)

theme_set(theme_jtc())

box_scores <- read_csv(here::here("content/data/nba-boxscores-2020.csv")) %>%
    rename(game_id = X1) %>%
    # appears to grab each row twice
    distinct(game_id, .keep_all = TRUE)

orig_sched <- read_excel(here::here("content/data/nba-full-schedule-2019-2020.xls"))

box_scores_processed <- box_scores %>%
    mutate(
        winner = tolower(winner),
        home_team = if_else(winner == "home", winning_abbr, losing_abbr),
        away_team = if_else(winner == "away", winning_abbr, losing_abbr)
    )

tidy_box_scores <- function(dat, home_away) {

    type <- home_away
    dat$win <- ifelse(dat$winner == type, 1L, 0L)
    dat <- dplyr::select(dat, game_id, win, pace, starts_with(type))
    orig <- names(dat)
    new <- str_remove(orig, "home_|away_")
    names(dat) <- new
    dat$type <- type
    dat$home <- as.integer(as.factor(dat$type))
    dat

}

box_scores_tidy <- bind_rows(
    tidy_box_scores(box_scores_processed, "home"),
    tidy_box_scores(box_scores_processed, "away")
)

```

## Looking at expected win percentage

Formula is:

$P = \mathcal{N}\frac{PPG - DPPG}{\sqrt{(var(PPG) + var(DPPG) - 2cov(PPG, DPPG)}}$

So for each team that looks like

```{r}

calc_win_pct <- function(ortg, drtg) {

    mean_o <- mean(ortg)
    mean_d <- mean(drtg)
    var_o <- var(ortg)
    var_d <- var(drtg)
    cov_od <- cov(ortg, drtg)

    pnorm((mean_o - mean_d) / sqrt(var_o + var_d - (2 * cov_od)))
}

predicted_wins <- box_scores_tidy %>%
    group_by(team) %>%
    summarise(win_pct_calc = calc_win_pct(offensive_rating, defensive_rating),
              win_pct_actual = mean(win),
              wins = sum(win))

predicted_wins %>%
    ggplot(aes(win_pct_calc, win_pct_actual, label = team)) +
        geom_point() +
        geom_text_repel() +
        geom_abline() +
        ylim(c(0, 1)) +
        xlim(c(0, 1))

```

## How would we expect teams to finish? 

Using the formula for expected win percentage, we can examine how we would have expected teams to finish the season. With this, we can look at how it compares to a) teams included in the bubble, b) how teams finish the first round of the bubble season before the playoffs start.  

```{r}

east_teams <- c("ATL", "BOS", "BRK", "CHI", "CHO", "CLE", "DET", "IND",
                "MIA", "MIL", "NYK", "ORL", "PHI", "TOR", "WAS")

predicted_wins %>%
    mutate(conference = if_else(team %in% east_teams, "East", "West")) %>%
    group_by(conference) %>%
    select(team, conference, win_pct_calc, win_pct_actual) %>%
    gather(type, pct, win_pct_calc:win_pct_actual) %>%
    ggplot(aes(type, pct, color = team, group = team)) +
        geom_point() +
        geom_line() +
        facet_wrap(~ conference) +
        geom_text_repel(aes(label = team)) +
        scale_y_continuous(labels = scales::percent) +
        scale_x_discrete(labels = c("Actual", "Predicted")) +
        theme(legend.position = "none") +
        labs(x = "",
             y = "Win Percentage")

```

A few things stand out:

1. Top of East: Many basketball commentators think that 2nd place in the East is really a toss up between Toronto and Boston. We know that Boston was on a hot streak right before the season was paused. While Toronto had a better regular-season record so far, this formula gives the slight edge to Boston for the second spot (although it doesn't say anything about how they would match-up in a playoff series). 
2. Top of West: The thing that really stands out here is Dallas. The predicted win perctange gives Dallas a much better record than their actual record. 
3. Bottom of East: Almost everyone agrees (or at least they did before all of Brooklyn's starting 5 completely turendover) that Washington had no buisness playing more basketball this year. And while there's still a large gap between the 8th and 9th spots, the predicted win percentage actually has CHicago and Detroit above Washington. 
4. Bottom of West: Similarly here, everyone thinks Phoenix is the outlier. And even though it will be almost impossible for them to get into the playoffs, from a predicted win percentage standpoint, they are much more in the mix than their actual record would suggest. 
