```{r setup}

library(tidyverse)
library(rethinking)
library(jtcr)
library(lubridate)

theme_set(theme_jtc())

box_scores <- read_csv(here::here("content/data/nba-boxscores-2020.csv")) %>%
    rename(game_id = X1)

box_scores_processed <- box_scores %>%
    mutate(
        winner = if_else(home_points > away_points, "home", "away"),
        home_team = if_else(home_wins == 1, winning_abbr, losing_abbr),
        away_team = if_else(home_wins == 1, losing_abbr, winning_abbr),
        home_net_rtg = home_offensive_rating - home_defensive_rating,
        away_net_rtg = away_offensive_rating - away_defensive_rating,
    )

fix_names <- function(dat, home_away) {

    type <- home_away
    dat$win <- ifelse(dat$winner == type, 1L, 0L)
    dat <- select(dat, game_id, win, starts_with(type))
    orig <- names(dat)
    new <- str_remove(orig, "home_|away_")
    names(dat) <- new
    dat$type <- type
    dat$home <- as.integer(as.factor(dat$type))
    dat

}

box_scores_tidy <- bind_rows(
    fix_names(box_scores_processed, "home"),
    fix_names(box_scores_processed, "away")
) %>%
    mutate(team_int = as.integer(as.factor(team)))

box_scores_tidy %>%
    mutate(team = fct_reorder(team, net_rtg)) %>%
    ggplot(aes(team, net_rtg)) +
        geom_boxplot() +
        coord_flip() +
        theme(axis.text.x = element_text(angle = 90))

```
```{r}

dat_list <- purrr::map(box_scores_tidy, as.vector)

mod <- ulam(
    alist(
        net_rtg ~ normal(mu, sigma),
        mu <- b1[team_int] *  + b2 * home,
        b1[team_int] ~ normal(b_mu, b_sig),
        b_mu ~ normal(0, 10),
        b_sig ~ exponential(1),
        b2 ~ normal(0, 0.5),
        sigma ~ exponential(1)
    ),
    data = dat_list,
    cores = parallel::detectCores()
)

precis(mod, depth = 2)

```

```{r}

preds <- sim(mod)

mean_pred <- apply(preds, 2, mean)

box_scores_tidy %>%
    mutate(pred = mean_pred,
           resid = pred - net_rtg) %>%
    ggplot(aes(net_rtg, resid)) +
        geom_point() +
        geom_smooth(method = "lm") +
        geom_abline()

```

