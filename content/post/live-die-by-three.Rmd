---
draft:true
---

```{r}

library(tidyverse)
library(rethinking)
library(nbastatR)
library(tidymodels)
library(jtcr)

theme_set(theme_jtc())

games <- nbastatR::game_logs(seasons = 2020)

game_threes <- games %>%
    group_by(idGame, nameTeam, isWin) %>%
    summarise(
        fg3a = sum(fg3a),
        fg3m = sum(fg3m)
    ) %>%
    mutate(pct3 = fg3m / fg3a)


team_threes <- game_threes %>%
    group_by(nameTeam) %>%
    summarise(
        season_fg3a = sum(fg3a),
        season_fg3m = sum(fg3m),
        season_wins = sum(isWin),
        season_played = n()
    ) %>%
    mutate(
        season_pct3 = season_fg3m / season_fg3a,
        win_pct = season_wins / season_played
    )

team_threes %>%
    mutate(
        nameTeam = fct_reorder(nameTeam, season_pct3)
    ) %>%
    ggplot(aes(nameTeam, season_pct3)) +
        geom_col() +
        coord_flip()


```

What is the relationship between three point percentage and winning percentage? 

```{r}
team_threes %>%
    ggplot(aes(season_pct3, win_pct)) +
        geom_point() +
        geom_text(aes(label = nameTeam), check_overlap = TRUE, hjust = 1, vjust = 1) 
```

Which teams are most dependent on the three? 

```{r}

three_summary <- game_threes %>%
    inner_join(team_threes, by = "nameTeam") %>%
    mutate(isWin = as.integer(isWin))

three_summary %>%
    ggplot(aes(factor(isWin), pct3)) +
        geom_boxplot() +
        facet_wrap(~ nameTeam)

```
```{r}

dat_list <- list(
    team = as.integer(as.factor(three_summary$nameTeam)),
    win = as.integer(three_summary$isWin),
    pct3 = scale(three_summary$pct3)
)

three_mod <- ulam(
    alist(
        win ~ binomial(1, p),
        logit(p) <- a[team] + b[team] * pct3,
        # priors
        a ~ multi_normal(0, Rho_a, sigma_a),
        b ~ multi_normal(0, Rho_b, sigma_b),
        sigma_a ~ exponential(1),
        sigma_b ~ exponential(1),
        Rho_a ~ lkj_corr(2),
        Rho_b ~ lkj_corr(2)
    ),
    data = dat_list,
    chains = 4, 
    cores = parallel::detectCores()
)

precis(three_mod, depth = 2)

```

How predictive is this model? 




