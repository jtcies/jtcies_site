---
draft: true
---



<pre class="r"><code>library(tidyverse)</code></pre>
<pre><code>## -- Attaching packages ---------------------------------- tidyverse 1.2.1 --</code></pre>
<pre><code>## v ggplot2 3.2.1     v purrr   0.3.2
## v tibble  2.1.3     v dplyr   0.8.3
## v tidyr   0.8.3     v stringr 1.4.0
## v readr   1.3.1     v forcats 0.4.0</code></pre>
<pre><code>## -- Conflicts ------------------------------------- tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code>library(rethinking)</code></pre>
<pre><code>## Loading required package: rstan</code></pre>
<pre><code>## Loading required package: StanHeaders</code></pre>
<pre><code>## rstan (Version 2.19.2, GitRev: 2e1f913d3ca3)</code></pre>
<pre><code>## For execution on a local, multicore CPU with excess RAM we recommend calling
## options(mc.cores = parallel::detectCores()).
## To avoid recompilation of unchanged Stan programs, we recommend calling
## rstan_options(auto_write = TRUE)</code></pre>
<pre><code>## For improved execution time, we recommend calling
## Sys.setenv(LOCAL_CPPFLAGS = &#39;-march=native&#39;)
## although this causes Stan to throw an error on a few processors.</code></pre>
<pre><code>## 
## Attaching package: &#39;rstan&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:tidyr&#39;:
## 
##     extract</code></pre>
<pre><code>## Loading required package: parallel</code></pre>
<pre><code>## rethinking (Version 1.88)</code></pre>
<pre><code>## 
## Attaching package: &#39;rethinking&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:purrr&#39;:
## 
##     map</code></pre>
<pre class="r"><code>library(jtcr)</code></pre>
<pre><code>## Registering fonts with R</code></pre>
<pre class="r"><code>url &lt;- &quot;https://www.baseball-reference.com/data/war_archive-2019-10-03.zip&quot; 

temp &lt;- tempfile()
download.file(url, temp)

batting &lt;- read_csv(unz(temp, &quot;war_daily_bat.txt&quot;), guess_max = 15000,
                    na = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)) %&gt;%
    janitor::clean_names() </code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   .default = col_double(),
##   name_common = col_character(),
##   player_ID = col_character(),
##   team_ID = col_character(),
##   lg_ID = col_character(),
##   pitcher = col_character()
## )</code></pre>
<pre><code>## See spec(...) for full column specifications.</code></pre>
<pre class="r"><code>pitching &lt;- read_csv(unz(temp, &quot;war_daily_pitch.txt&quot;), guess_max = 20000,
                     na = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)) %&gt;%
    janitor::clean_names() </code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   .default = col_double(),
##   name_common = col_character(),
##   player_ID = col_character(),
##   team_ID = col_character(),
##   lg_ID = col_character()
## )
## See spec(...) for full column specifications.</code></pre>
<pre class="r"><code>unlink(temp)</code></pre>
<pre class="r"><code>batting %&gt;%
    filter(year_id == 2019, pitcher == &quot;N&quot;) %&gt;%
    ggplot(aes(salary, war)) + 
        geom_point() +
        geom_text(aes(label = name_common), check_overlap = TRUE) +
        theme_jtc() </code></pre>
<pre><code>## Warning: Removed 266 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 266 rows containing missing values (geom_text).</code></pre>
<pre><code>## Warning in grid.Call(C_stringMetric, as.graphicsAnnot(x$label)): font
## family not found in Windows font database

## Warning in grid.Call(C_stringMetric, as.graphicsAnnot(x$label)): font
## family not found in Windows font database</code></pre>
<pre><code>## Warning in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y, :
## font family not found in Windows font database

## Warning in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y, :
## font family not found in Windows font database

## Warning in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y, :
## font family not found in Windows font database

## Warning in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y, :
## font family not found in Windows font database

## Warning in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y, :
## font family not found in Windows font database

## Warning in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y, :
## font family not found in Windows font database

## Warning in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y, :
## font family not found in Windows font database</code></pre>
<pre><code>## Warning in grid.Call.graphics(C_text, as.graphicsAnnot(x$label), x$x,
## x$y, : font family not found in Windows font database</code></pre>
<p><img src="/post/baseball-war_files/figure-html/allstar-1.png" width="672" /></p>
<pre class="r"><code>batting %&gt;%
    filter(name_common == &quot;Jose Altuve&quot;) %&gt;%
    ggplot(aes(factor(year_id), war, group = 1)) +
        geom_line() + 
        ylim(c(0, NA)) +
        theme_jtc() +
        labs(x = &quot;year&quot;)</code></pre>
<pre><code>## Warning in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y, :
## font family not found in Windows font database

## Warning in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y, :
## font family not found in Windows font database

## Warning in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y, :
## font family not found in Windows font database

## Warning in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y, :
## font family not found in Windows font database

## Warning in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y, :
## font family not found in Windows font database

## Warning in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y, :
## font family not found in Windows font database

## Warning in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y, :
## font family not found in Windows font database</code></pre>
<pre><code>## Warning in grid.Call.graphics(C_text, as.graphicsAnnot(x$label), x$x,
## x$y, : font family not found in Windows font database</code></pre>
<p><img src="/post/baseball-war_files/figure-html/altuve-1.png" width="672" /></p>
<p>Altuve is a 2019 All-Star who will be 30 years old next season. Heâ€™s the 2017 AL MVP whose production has declined somewhat in the past few years, but is still an elite player.</p>
<pre class="r"><code>pitching %&gt;%
    filter(year_id == 2019, age &lt; 22) </code></pre>
<pre><code>## # A tibble: 12 x 42
##    name_common   age mlb_id player_id year_id team_id stint_id lg_id     g
##    &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;
##  1 Kolby Alla~    21 663465 allarko01    2019 TEX            1 AL        9
##  2 Emmanuel C~    21 661403 claseem01    2019 TEX            1 AL       21
##  3 Brusdar Gr~    20 660813 gratebr01    2019 MIN            1 AL       10
##  4 Elvis Luci~    19 672773 luciael01    2019 TOR            1 AL       25
##  5 Jesus Luza~    21 666200 luzarje01    2019 OAK            1 AL        6
##  6 Dustin May     21 669160 maydu01      2019 LAD            1 NL       14
##  7 Adrian Mor~    20 670970 morejad01    2019 SDP            1 NL        5
##  8 Andres Mun~    20 662253 munozan01    2019 SDP            1 NL       22
##  9 Mike Soroka    21 647336 sorokmi01    2019 ATL            1 NL       29
## 10 Jose Suarez    21 660761 suarejo01    2019 LAA            1 AL       19
## 11 Bryse Wils~    21 669060 wilsobr02    2019 ATL            1 NL        6
## 12 Huascar Yn~    21 660623 ynoahu01     2019 ATL            1 NL        2
## # ... with 33 more variables: gs &lt;dbl&gt;, i_pouts &lt;dbl&gt;,
## #   i_pouts_start &lt;dbl&gt;, i_pouts_relief &lt;dbl&gt;, ra &lt;dbl&gt;, x_ra &lt;dbl&gt;,
## #   x_ra_sprp_adj &lt;dbl&gt;, x_ra_def_pitcher &lt;dbl&gt;, ppf &lt;dbl&gt;,
## #   ppf_custom &lt;dbl&gt;, x_ra_final &lt;dbl&gt;, bip &lt;dbl&gt;, bip_perc &lt;dbl&gt;,
## #   rs_def_total &lt;dbl&gt;, runs_above_avg &lt;dbl&gt;, runs_above_avg_adj &lt;dbl&gt;,
## #   runs_above_rep &lt;dbl&gt;, rp_o_replacement &lt;dbl&gt;,
## #   gr_leverage_index_avg &lt;dbl&gt;, war &lt;dbl&gt;, salary &lt;dbl&gt;, team_rp_g &lt;dbl&gt;,
## #   opp_rp_g &lt;dbl&gt;, pyth_exponent &lt;dbl&gt;, waa_win_perc &lt;dbl&gt;, waa &lt;dbl&gt;,
## #   waa_adj &lt;dbl&gt;, opp_rp_g_rep &lt;dbl&gt;, pyth_exponent_rep &lt;dbl&gt;,
## #   waa_win_perc_rep &lt;dbl&gt;, war_rep &lt;dbl&gt;, era_plus &lt;dbl&gt;, er_lg &lt;dbl&gt;</code></pre>
<div id="model-specifcation" class="section level2">
<h2>Model specifcation</h2>
<pre class="r"><code>process_data &lt;- function(df) {
   
    df %&gt;%
    group_by(player_id) %&gt;%
    filter(min(year_id) &gt;= 1990) %&gt;%
    mutate(
        player_year = year_id - min(year_id) + 1,
    ) %&gt;%  
    ungroup() %&gt;%
    complete(nesting(player_id, position),
             player_year, fill = list(war = -0.5)) %&gt;%
    group_by(player_id) %&gt;%
    arrange(player_year) %&gt;%
    mutate(
        prev_war = lag(war, default = -0.5),
        keep = if_else(min(year_id, na.rm = TRUE) + player_year - 1 &gt; 2019, FALSE, TRUE), 
        lg_id = as.integer(as.factor(lg_id))
    ) %&gt;%
    ungroup() %&gt;%
    arrange(player_id, player_year) %&gt;%
    fill(lg_id) %&gt;%
    filter(keep) %&gt;%
    select(player_id, position, lg_id, player_year, war, prev_war)

}


war_hist &lt;- bind_rows(

    batting %&gt;%
        mutate(position = 1) %&gt;%
        filter(pitcher == &quot;N&quot;) %&gt;%
        process_data(),

    pitching %&gt;% 
        mutate(position = 2) %&gt;%
        process_data() 

) </code></pre>
<pre class="r"><code>library(lme4)</code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## 
## Attaching package: &#39;Matrix&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:tidyr&#39;:
## 
##     expand</code></pre>
<pre class="r"><code>war_hist %&gt;%
    ggplot(aes(player_year, war, group = player_id)) +
        geom_line(alpha = 0.05)</code></pre>
<p><img src="/post/baseball-war_files/figure-html/waryear-1.png" width="672" /></p>
</div>
<div id="model-specification" class="section level2">
<h2>Model specification</h2>
<pre class="r"><code># library(splines)
# library(broom)
# 
# test_players &lt;- sample(unique(war_hist$player_id), 10)
# 
# war_hist_processed &lt;- war_hist %&gt;%
#     mutate(
#         player_index = as.integer(as.factor(player_id)),
#         position = as.integer(position),
#         player_year = as.integer(player_year)
#     ) %&gt;%
#     filter(player_id %in% test_players)
# 
# 
# fit_lm &lt;- function(df) {
#     lm(war ~ poly(player_year, 3), data = df)
# }
# 
# fit_splines &lt;- function(df) {
#     lm(war ~ ns(player_year, 3), data = df)
# }
# 
# 
# modeled &lt;- war_hist_processed %&gt;%
#     nest(-player_id) %&gt;%
#     mutate(
#         linear_mod = purrr::map(data, fit_lm),
#         splines_mod = purrr::map(data, fit_splines),
#         fitted_lm = purrr::map2(linear_mod, data, ~augment(.x, newdata = .y)),
#         fitted_splines = purrr::map2(splines_mod, data, ~augment(.x, newdata = .y))
#     )
# 
# modeled %&gt;%
#     slice(1) %&gt;%
#     select(player_id, linear_mod) %&gt;%
#     unnest(tidy(linear_mod))
# </code></pre>
</div>
