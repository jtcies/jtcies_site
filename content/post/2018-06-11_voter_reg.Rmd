---
title: "Voter Registration"
author: "Joe Ciesielski"
date: "6/11/2018"
output: html_document
draft: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(readxl)
library(here)
library(tidycensus)
library(stringr)
library(GGally)
library(ipumsr)

fix_names <- function(x) {
  names(x) <- tolower(make.names(names(x)))
  names(x) <- str_replace_all(names(x), "[/.]+", "_")
  x
}

get_census_data <- function(vars) {
  get_acs(geography = "county", variables = vars) %>% 
    select(-moe, -NAME) %>% 
    spread(variable, estimate)
}

# read in cps data
ddi <- read_ipums_ddi(here::here("data/cps_00002.xml"))
voting <- read_ipums_micro(ddi)

# only keep those that have county
county <- voting %>% 
  fix_names() %>% 
  filter(county != 0,
         !is.na(voreg))

# state voter registration and voting info
state_voting <- "data/table04a.xls" %>% 
  here::here() %>% 
  read_excel(skip = 4) %>% 
  rename(state = X__1,
         total_pop = X__2,
         total_citizens = X__3) %>% 
  slice(2:52) %>% 
  mutate(state = tolower(state)) %>% 
  fix_names()

# educational characteristics
educ_vars <- c(pop_25_older = "B23006_001",
               bach_or_higher = "B23006_023")
               
pov_vars <- c(pop = "B06012_001",
              blw_pov = "B06012_002")

age <- c(med_age = "B01002_001")

race <- c(black = "B01001B_001",
          latino = "B18101I_001")

demos <- list(educ_vars, pov_vars, age, race) %>% 
  map_dfc(get_census_data) %>% 
  mutate(
    pct_blw_pov = blw_pov / pop,
    pct_bach = bach_or_higher / pop_25_older,
    pct_black = black / pop,
    pct_latino = latino / pop
  )

```



