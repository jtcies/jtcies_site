---
title: "Voter Registration"
author: "Joe Ciesielski"
date: "6/11/2018"
output: html_document
draft: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(readxl)
library(here)
library(tidycensus)
library(stringr)
library(GGally)
library(stringr)
library(httr)

fix_names <- function(x) {
  names(x) <- tolower(make.names(names(x)))
  names(x) <- str_replace_all(names(x), "[/.]+", "_")
  x
}

make_names <- function(x) {
  x <- tolower(make.names(x))
  x <- str_replace_all(x, "[/.]+", "_")
  x
}

download_state_data <- function(x) {
  url <- paste0(
     "https://www2.census.gov/programs-surveys/demo/tables/voting/", 
     x, 
     ".xlsx"
   )
  GET(url, write_disk(tmp <- tempfile(fileext = ".xlsx")))
  df <- read_excel(tmp, skip = 1)
  names(df)[1] <- "variable"
  df %>% 
    fix_names() %>% 
    slice(1:29) %>% 
    filter(!is.na(estimate)) %>% 
    mutate(state = x)
}

capitalize <- function(x) {
  # capitalze all not conjunction words
  x <- tolower(x)
  x <- gsub("(?<!^)\\b(?:the|an?|[io]n|at|with(?:out)?|from|for|and|but|n?or|yet|[st]o|around|by|after|along|from|of)\\b(*SKIP)(*FAIL)|\\b(\\pL)", "\\U\\1", x, perl=T)
  x <- str_replace_all(x, " ", "")
  x
}

# state voter registration and voting info
state_voting <- "data/table04a.xls" %>% 
  here::here() %>% 
  read_excel(skip = 4) %>% 
  rename(state = X__1,
         total_pop = X__2,
         total_citizens = X__3) %>% 
  slice(2:52) %>% 
  mutate(state = capitalize(state)) %>% 
  fix_names()

state_demos <- state_voting$state %>%
  map_dfr(download_state_data) %>% 
  mutate(variable = make_names(variable))

```



