---
draft: true
---

```{r setup}

library(tidyverse)
library(nbastatR)
library(rethinking)
library(googledrive)

games <- seasons_schedule(seasons = 2019)

game_ids <- games$idGame

game_1  <- game_ids[[1]]

game_1_pbp <- play_by_play_v2(game_1)
```



```{r g1firstaction}

game_1_first_action <- game_1_pbp %>%
    select(namePlayer1, namePlayer2, minuteGame, numberPeriod) %>%
    gather(drop, player, 1:2) %>%
    select(-drop) %>%
    group_by(player) %>%
    filter(minuteGame == min(minuteGame), !is.na(player)) %>%
    arrange(minuteGame) 

game_1_first_action %>%
    as.data.frame()
```
```{ri g1gt}

game_1_pbp %>% 
    fill(scoreAway, scoreHome, marginScore) %>%
    filter(minuteGame == 46.55) %>%
    select(scoreAway, scoreHome, marginScore)  %>%
    distinct()

```

```{r gtfun}

get_garbage_time_score <- function(game_pbp) {

    # excludes OT

    player_starts <- game_pbp %>%
        fill(marginScore) %>%
        filter(!is.na(namePlayer1), !is.na(namePlayer2)) %>%
        mutate(player1 = paste0(slugTeamPlayer1, "_", namePlayer1),
               player2 = paste0(slugTeamPlayer2, "_", namePlayer2)) %>%
        select(player1, player2, minuteGame, marginScore, idGame) %>%
        gather(drop, player, 1:2) %>%
        separate(player, into = c("team", "player"), sep = "_") %>%
        select(-drop) %>%
        group_by(player) %>%
        filter(minuteGame == min(minuteGame), !is.na(player)) %>%
        ungroup() %>%
        group_by(team) %>%
        arrange(minuteGame) %>%
        mutate(n_player = row_number()) %>% 
        ungroup() %>%
        replace_na(list(marginScore = 0)) 
        
    final_margin <- game_pbp %>%
        filter(minuteGame <= 48, !is.na(marginScore)) %>% 
        arrange(desc(minuteGame)) %>%
        slice(1) %>%
        pull("marginScore")
        
    player_starts %>%
        mutate(final_margin = final_margin)

}

get_garbage_time_score(game_1_pbp)
```

```{r getgt}
# you can use this below to download yourself
# it's a big file so I've uploaded it to my google drive 

# game_ids <- games$idGame

# games_pbp <- purrr::map_dfr(game_ids, play_by_play_v2)

# if you want to download yourself, you can use this code
#game_ids <- games$idGame

# games_pbp <- purrr::map_dfr(game_ids, play_by_play_v2)

# i've already uploaded the full play by play for 2019 to my google drive. 
# you can access here: https://drive.google.com/open?id=1J4oHD-8ILt9nOAVgw8GoEyBtct8BO4y8

temp_dir <- tempdir()

drive_download(
    file = as_id("1J4oHD-8ILt9nOAVgw8GoEyBtct8BO4y8"),
    path = file.path(temp_dir, "nba_pbp_2019.csv")
)

games_pbp <- read_csv(file.path(temp_dir, "nba_pbp_2019.csv"))

# length(unique(games_pbp$idGame))
# [1] 1227 -  missing three games

games_gt <- games_pbp %>% 
    split(.$idGame) %>% 
    map_dfr(get_garbage_time_score)
```

```{r}

games_gt %>%
    filter(minuteGame < 48,
           n_player > 5) %>%
    ggplot(aes(minuteGame, abs(marginScore))) +
        geom_jitter() +
        facet_wrap(~n_player) +
        xlim(c(0, 48)) +
        annotate("rect", xmin = 36, ymin = 10, xmax = 48, ymax = Inf,
                  alpha = 0.2, fill = "red") +
        annotate("rect", xmin = 45, ymin = 0, xmax = 48, ymax = Inf,
                  alpha = 0.2, fill = "blue")

```

For these purposes, it looks like we pretty confidently say that it's garbage time if the 10th player sees their first action in the fourth quarter with a margin of at least 10 points or if the 10th player sees their first action with less than three minutes left in the game. 


```{r}

garbage_time_start <- games_gt %>%
    filter(minuteGame <= 48) %>%
    mutate(
        gt = if_else(
            (n_player >= 10 & minuteGame >= 36 & abs(marginScore) >= 10) |
                (n_player >= 10 & minuteGame >= 45),
            1L, 0L
        )
    ) %>%
    filter(gt == 1) %>% 
    arrange(minuteGame, desc(marginScore)) %>%
    distinct(idGame, .keep_all = TRUE) %>%
    select(-team, -player, -n_player)

no_gt <- games_gt %>%
    anti_join(garbage_time_start, by = "idGame") %>% 
    group_by(idGame) %>% 
    mutate(marginScore = final_margin,
           minuteGame = 48,
           gt = 0L)  %>% 
    arrange(desc(n_player)) %>% 
    distinct(idGame, .keep_all = TRUE) %>% 
    select(-team, -player, -n_player)

all_gt <- bind_rows(garbage_time_start, no_gt)

all_gt %>%
    ggplot(aes(minuteGame, abs(marginScore))) +
        geom_jitter()
```


```{r priorsim}

N <- 100

minute <- seq(0, 12, by = 0.1)

beta_sim <- rnorm(N, 0, 2)

alpha <- rnorm(N, 0, 2)


tibble(minute) %>%
    mutate(margin = 25 - exp(.002 * minute ^ 3)) %>% 
    ggplot(aes(minute, margin)) +
        geom_line()

```


```{r gtmod}

gt_start_list <- list(
    minute = garbage_time_start$minuteGame - 36,
    margin = abs(garbage_time_start$marginScore)
)

gt_mod <- ulam(
    alist(
        margin ~ normal(mu, sigma),
        mu <- a - exp(b * minute ^ 3), 
        a ~ normal(25, 5),
        b ~ normal(0.001, 0.0001),
        sigma ~ exponential(1)
    ),
    data = gt_start_list
)

precis(gt_mod)

sim_dat <- tibble(
    minute = seq(0, 12, by = 0.1)
)

preds <- link(gt_mod, data = sim_dat) %>% 
    t() %>%
    as_tibble() %>% 
    bind_cols(sim_dat) %>% 
    gather(var, val, 1:500) %>% 
    select(-var)


actual_plot <- garbage_time_start %>% 
    select(minute = minuteGame, margin = marginScore)  %>% 
    mutate(margin = abs(margin),
           minute = minute - 36)

preds %>% 
    group_by(minute) %>% 
    summarise(mean = mean(val), 
              sd = sd(val)) %>% 
    ggplot(aes(minute, mean)) +
        geom_line() +
        geom_ribbon(aes(ymin = mean - 2 * sd, ymax = mean + 2 * sd), alpha = 0.2) +
        geom_point(data = actual_plot, aes(x = minute, y = margin), inherit.aes = FALSE)

```

## When is a game decided? 

```{r}

fourth_qtr_scores <- games_pbp %>%
    group_by(idGame) %>%
    fill(marginScore) %>%
    arrange(minuteGame, desc(marginScore)) %>%
    distinct(idGame, minuteGame, marginScore) %>%
    filter(minuteGame >= 36, minuteGame <= 48)

final_scores <- fourth_qtr_scores %>%
    filter(minuteGame == max(minuteGame)) %>%
    select(idGame, final_score = marginScore)

fourth_qtr_w_final <- fourth_qtr_scores %>%
    inner_join(final_scores, by = "idGame") %>%
    mutate(home_win = final_score > 0,
           home_winning = marginScore > 0,
           winning_team_ahead = home_win == home_winning)

fourth_qtr_w_final %>%
    group_by(minute = round(minuteGame, 0), margin = abs(marginScore)) %>%
    summarise(win_rate = mean(winning_team_ahead)) %>%
    mutate(
        pct75 = win_rate > .75,
        pct90 = win_rate > .9,
        pct95 = win_rate > .95,
        pct99 = win_rate > .99
    ) %>%
    gather(metric, val, pct75:pct99) %>%
    filter(val) %>%
    ggplot(aes(minute, margin, color = metric)) +
        geom_line()



```


## Other questions?

- What are other ways to define garbage time start (than a player's first action)? 
- How do coaches differ in whether or not they go into garbage time mode? 
- Has the boundry for garbage time changed over time? 
- How close does the score have to get for a coach to put their starters back in?
- How to factor in games going to overtime? 
- When should garbage time actually kick in (i.e. when should a game be considered decided)? 

