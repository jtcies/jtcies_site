---
draft: true
---

```{r setup}

library(tidyverse)
library(nbastatR)
library(rethinking)
library(googledrive)

games <- game_logs(seasons = 2019, parse_boxscores = TRUE)

game_ids <- distinct(games, idGame)

game_1  <- game_ids[[1]]

game_1_pbp <- play_by_play_v2(game_1, return_message = FALSE)
```
```{r game1pbp}

game_1_pbp %>%
    View()

```
```{r g1firstaction}

game_1_first_action <- game_1_pbp %>%
    select(namePlayer1, namePlayer2, minuteGame, numberPeriod) %>%
    gather(drop, player, 1:2) %>%
    select(-drop) %>%
    group_by(player) %>%
    filter(minuteGame == min(minuteGame), !is.na(player)) %>%
    arrange(minuteGame) 

game_1_first_action %>%
    as.data.frame()
```
```{ri g1gt}

game_1_pbp %>% 
    fill(scoreAway, scoreHome, marginScore) %>%
    filter(minuteGame == 46.55) %>%
    select(scoreAway, scoreHome, marginScore)  %>%
    distinct()

```

```{r gtfun}

get_garbage_time_score <- function(game_pbp) {

    # excludes OT

    player_starts <- game_pbp %>%
        fill(marginScore) %>%
        filter(!is.na(namePlayer1), !is.na(namePlayer2)) %>%
        mutate(player1 = paste0(slugTeamPlayer1, "_", namePlayer1),
               player2 = paste0(slugTeamPlayer2, "_", namePlayer2)) %>%
        select(player1, player2, minuteGame, marginScore, idGame) %>%
        gather(drop, player, 1:2) %>%
        separate(player, into = c("team", "player"), sep = "_") %>%
        select(-drop) %>%
        group_by(player) %>%
        filter(minuteGame == min(minuteGame), !is.na(player)) %>%
        ungroup() %>%
        group_by(team) %>%
        arrange(minuteGame) %>%
        mutate(n_player = row_number()) %>% 
        ungroup() %>%
        replace_na(list(marginScore = 0)) %>% as.data.frame

    }
 
    gt_score <- game_pbp %>%
         fill(marginScore) %>%
         filter(minuteGame == gt) %>%
         arrange(desc(abs(marginScore))) %>%
         distinct(idGame, minuteGame, .keep_all = TRUE) %>%
         select(idGame, minuteGame, marginScore) %>%
         mutate(
            n_players = n_players,
            garbage = if_else(minuteGame < 48, 1L, 0L)
        )
 
    gt_score

}

get_garbage_time_score(game_1_pbp)
```

```{r getgt}
# you can use this below to download yourself
# it's a big file so I've uploaded it to my google drive 

# game_ids <- games$idGame

# games_pbp <- purrr::map_dfr(game_ids, play_by_play_v2)

# if you want to download yourself, you can use this code
#game_ids <- games$idGame

# games_pbp <- purrr::map_dfr(game_ids, play_by_play_v2)

# i've already uploaded the full play by play for 2019 to my google drive. 
# you can access here: https://drive.google.com/open?id=1J4oHD-8ILt9nOAVgw8GoEyBtct8BO4y8

temp_dir <- tempdir()

drive_download(
    file = as_id("1J4oHD-8ILt9nOAVgw8GoEyBtct8BO4y8"),
   path = file.path(temp_dir, "nba_pbp_2019.csv")
)

games_pbp <- read_csv(file.path(temp_dir, "nba_pbp_2019.csv"))

# length(unique(games_pbp$idGame))
# [1] 1227 -  missing three games

games_gt <- games_pbp %>% 
    split(.$idGame) %>% 

    map_dfr(get_garbage_time_score)
```

```{r}

games_gt %>%
    filter(minuteGame < 48,
           n_player > 5) %>%
    ggplot(aes(minuteGame, abs(marginScore))) +
        geom_jitter() +
        facet_wrap(~n_player) +
        xlim(c(0, 48)) +
        annotate("rect", xmin = 36, ymin = 10, xmax = 48, ymax = Inf,
                  alpha = 0.2, fill = "red") +
        annotate("rect", xmin = 45, ymin = 0, xmax = 48, ymax = Inf,
                  alpha = 0.2, fill = "blue")

```

```{r}

games_gt %>%
    filter(n_player >= 13) %>% 
    distinct(idGame)

games
```


## Other questions?

- What are other ways to define garbage time start (than a player's first aciton)? 
- How do coaches differ in whether or not they go into garbage time mode? 
- Has the boundry for garbage time changed over time? 
- How close does the score have to get for a coach to put their starters back in?
- How to factor in games going to overtime? 
- When should garbage time actually kick in (i.e. when should a game be considered decided)? 

