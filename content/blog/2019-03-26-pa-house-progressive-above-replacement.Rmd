---
title: PA House - Progressive Above Replacement
author: Joseph Ciesielski
date: '2019-03-26'
slug: pa-house-progressive-above-replacement
categories: []
tags: []
comments: no
showcomments: yes
showpagemeta: yes
draft: true
---

```{r}

library(tidyverse)
library(rvest)
library(broom)
library(scales)

theme_set(theme_minimal())

```

State legislatures were not immune to the much discussed 'blue wave' of 2018. In Pennsylvania, a number of candidates ran on progressive and far left platfroms and won including Sara Innamoroto, Summer Lee, and Elizabeth Fiedler. 

A few months ago, Data for Progress put out a piece of US House Democrats fared on their '[Progressive above Replacement](https://www.dataforprogress.org/par-scores)' score. They predicted how progressive a Democrat should be based on characteristics of their district; progressive-ness was rated based on votes and co-sponsorships of bills in key progressive issues including public housing, tuition-free college, and renewable energy. 

Given the excitement about some of the far-left candidates for Pennsylvania's State House, I wanted to replicate this approach. 

I also wanted to see if scores on this metrics had any relationship to whether candidates were re-elected (or decided not to run) in 2018. 

## Methodology

I used votes on the following key divisive bills to asses progressiveness:

	- Bill 2154: rolling back regulations on oil and gas drilling
	- Bill 97: charter school reform
	- Bill 2060: taking away guns from domestic abusers
	- Bill 178: allowing teachers to be laid off based on evaluations
	- Bill 1419: expunging criminal records for those with minor offences
	- Bill 27: shielding names of officers involved in shootings
	- Bill 110: imposing limits on spending growth
	- Bill 2017: overturning Department of Revenue ruling disallowing deduction of business expenses
	- Bill 2477: funding medical marijuana research
	- Bill 2138: work requirements for Medicaid
	- Bill 2050: banning abortions for fetuses with Downs Syndrome 

### Data wrangling

We'll use four different data sets for this analysis. I scrpaed each from the web [add links] but saved each to my Github account. Let's read in each one at a time and take a look. 

```{r}

scrape_election <- function(year) {
  
 sprintf(
   "https://en.wikipedia.org/wiki/%i_Pennsylvania_House_of_Representatives_election",
   year
 ) %>% 
    read_html() %>%
    html_table(fill = TRUE) %>%
    .[[19]] %>%
    janitor::clean_names() %>%
    tbl_df() %>%
    select(-party, -party_2, -party_3, -percent) %>%
    rename(party = party_4) %>% 
    mutate(
      year = year,
      votes = parse_number(votes)
    )

}

election_results <- c(2016,  2018) %>% 
  map_dfr(scrape_election) %>% 
  group_by(district, year) %>% 
  mutate(percent = votes / sum(votes)) %>% 
  ungroup()


```
The first is the results from the 2016 PA House general election. I've already calculated the percent of votes that went for the Democrat. 

```{r}

bills <- read_csv("https://raw.githubusercontent.com/jtcies/jtcies_site/master/content/data/pa-par/pa_house_bills_2017-18.csv")


bills
```

This data shows the bills, the topic, and whether or not a vote for the bill would be considered perspective. Next is how the reps votes on each of those bills ...

```{r}

votes <- read_csv("https://raw.githubusercontent.com/jtcies/jtcies_site/master/content/data/pa-par/bill_votes.csv")

votes
```

... who won the 2018 election (so we can use this as an outcome) ...

```{r}

reps_2018 <- read_csv("https://raw.githubusercontent.com/jtcies/jtcies_site/master/content/data/pa-par/reps_2018.csv")

reps_2018
```

... and a data set with the different name formats so we can combine the election results with the legislative data. 

Phew, ok. Now we can start merging some of the data together. The goal is create a data set that inlcude election results, voting record, and whether someone was still a rep in 2018. 

First pull out the election winners. No independents won in 2016, so that makes this a little easier.

```{r}

election_tidy <- election_results %>%
    group_by(district, year) %>%
    mutate(
		win = percent == max(percent),
		margin = (percent - lead(percent, default = 0)) * 100
	) %>%
	filter(win) %>% 
  ungroup() %>% 
  rename(representative = candidate)

election_both <- election_tidy %>% 
  filter(year == 2016) %>% 
  left_join(
    election_tidy %>% 
      filter(year == 2018), 
    by = "district",
    suffix = c("_2016", "_2018")
    ) %>% 
  mutate(same = representative_2016 == representative_2018)

election_both
```

Now we'll get a summary

```{r}

prog_summary <- votes %>% 
    left_join(bills, by = "bill") %>%
    mutate(
      progressive_vote = case_when(
        progressive == 1 & vote == "yay" ~ 1,
        progressive == -1 & vote == "yay" ~ 0,
        progressive == 1 & vote == "nay" ~ 0,
        progressive == -1 & vote == "nay" ~ 1
      )
    ) %>% 
  group_by(rep) %>% 
  summarise(
	progressive_avg = mean(progressive_vote),
	votes_cast = n()
	)

```

Merge the data.

```{r}

election_merge <- election_both %>%
	separate(representative_2016, into = c("first", "last", "suffix"), sep = " |-",
	         remove = FALSE) %>%
	mutate_at(vars(first, last, suffix), tolower) %>%
	group_by(last) %>%
	mutate(
		merge_name = case_when(
			!is.na(suffix) ~ suffix,
			length(row_number()) > 1 ~ paste0(last, " ", str_sub(first, 1, 1)),
			TRUE ~ last
		),
		merge_name = case_when(
			merge_name == "keller m" ~ "keller mk",
			merge_name == "keller b" ~ "keller w",
			merge_name == "braneky" ~ "krueger",
			merge_name == "quinn" & str_detect(last, "marguerite") ~ "quinn m",
			merge_name == "quinn" ~ "quinn c",
			merge_name == "day g" ~ "day",
			TRUE ~ merge_name
		)
	) %>%
	ungroup()


prog_merge <- prog_summary %>%
	mutate(rep = tolower(str_replace_all(rep, ",|\\.", "")))


pa_house_tidy <- election_merge %>%
	left_join(prog_merge, by = c("merge_name" = "rep"))

```


## Visulizing

First let's look at margin of victory by party. We should have 121 Repbublicans and 82 Democrats. 

```{r}

pa_house_tidy %>% 
  count(party_2016)

```

```{r}
pa_house_tidy %>% 
  ggplot(aes(margin_2016, fill = party_2016)) +
    geom_histogram(binwidth = 2, show.legend = FALSE) +
    facet_wrap(~party_2016) +
    scale_fill_manual(
      values = c("Democratic" = "blue",
                 "Republican" = "red")
    ) +
    labs(
			x = "margin of victory - 2016 election"
    )
    

```

It looks like both parties had an equal number of wins in uncontested districts, but Democrats had a greater percentage (because they held fewer seats).

```{r}
pa_house_tidy %>%
  group_by(party_2016) %>% 
  summarise(
    `count uncontested` = sum(margin_2016 == 100),
    `percent uncontested` = percent(mean(margin_2016 == 100))
  ) %>% 
  knitr::kable()
 
```

```{r}

pa_house_tidy %>% 
  group_by(party_2016) %>% 
  summarise(
    `count incumbent win` = sum(representative_2016 == representative_2018),
    `count flipped party` = sum(party_2016 == party_2018)
  ) %>% 
  knitr::kable()

```



```{r}

pa_house_tidy %>% 
  ggplot(aes(margin_2016, margin_2018, color = party_2018)) +
    geom_point(size = 3) +
    facet_wrap(~ party_2016, ncol = 1) +
     scale_color_manual(
      values = c("Democratic" = "blue",
                 "Republican" = "red")
    ) 

```


### Progressiveness by win margin

```{r}
par_mod <- glm(
	progressive_avg ~ margin_2016 * party_2016, 
	data = pa_house_tidy,
	family = "binomial",
	weights = votes_cast
)

par_mod %>% 
  tidy()
```


```{r}
augmented <- augment(par_mod, type.predict = "response", newdata = pa_house_tidy)	

augmented %>%
	ggplot(aes(x = margin_2016, color = party_2016)) +
    geom_point(
      data = pa_house_tidy[pa_house_tidy$same, ],
      aes(y = progressive_avg),
      size = 5,
      color = "black"
    ) +
		geom_point(aes(y = progressive_avg), size = 3) +
  	geom_line(aes(y = .fitted), linetype = 3, size = 2, show.legend = FALSE) +
		scale_color_manual(
			values = c("Democratic" = "blue",
					   "Republican" = "red")
		) +
		labs(
			x = "margin of victory - 2016 election",
			y = "progressive avg",
			color = ""	
		)

```

There is definitely a trend that shows Democrats as more progressive and Republicans as less progressive if they won their district by a greater margin. However, it's not a huge magnitude. A Democrat who won by less than one point is expeted to have about a .73 progressive average, compared to a Democrat winning uncontested, who is expected to vote progressive about 82% of the time. 

However, it stands out to me that most Republicans who were re-elected in 2018 are less progressive than those who did not win re-election. 

We can use the residuals from our inital model to determine if voting more or less progressive than the model expects has any relation to being elected then next year. 

```{r}

reelect_mod <- augmented %>% 
  mutate(resid = progressive_avg - .fitted) %>% 
  glm(same ~ resid * party_2016, data = ., family = "binomial")

reelect_mod %>% 
  tidy()

```

Legislators who were more partisan were more likley to be re-elected. This is espeically true for Repbulicans, which makes sense in a year where momentum was behind Democrats. However, the difference is not statistically signifcant. 

## Legislators of interest.

Let's take a look at two groups: Democrats in uncontested voes who are less progressive than expected, and those Republicans who were more progressive and only won by small margins and were not re-elected. 

```{r}
dems_less_progressive <- augmented %>% 
  filter(
    party_2016 == "Democratic", margin_2016 == 100,
    progressive_avg < .fitted
  )
```

There are `r nrow(dems_less_progressive)` Democrats in uncontested races who were less progressive than expected. Let's look at the top 10. 

```{r}
dems_less_progressive %>% 
  arrange(progressive_avg) %>% 
  slice(1:10) %>% 
  select(district, party_2016, representative_2016, margin_2016,
         progressive_avg, party_2018, representative_2018, margin_2018)

```

All were re-elected, and all but one had uncontested general elections in 2018 (although some may have been primaried). 
